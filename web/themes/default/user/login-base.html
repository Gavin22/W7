{template 'common/header-base'}
<div class="system-login" style="background-image: url({if !empty($_W['setting']['copyright']['background_img'])} {php echo to_global_media($_W['setting']['copyright']['background_img']);} {/if});">
	<div class="head">
		<a href="/" class="logo-version">
			<img src="{if !empty($_W['setting']['copyright']['flogo'])}{php echo to_global_media($_W['setting']['copyright']['flogo'])}{else}./resource/images/logo/login-logo.png{/if}" class="logo">
			<span class="version hidden">{IMS_VERSION}</span>
		</a>
		{if !empty($_W['setting']['copyright']['showhomepage'])}
		<a href="{$_W['siteroot']}" class="pull-right">首页</a>
		{/if}
	</div>
	<div class="login-panel">
		<div class="title">
			<a href="javascript:void(0);">账号/手机登录</a>
		</div>
		<form id="login-form" action="" method="post" class="we7-form">
			<div class="input-group-vertical">
				<input name="login_type" type="hidden" class="form-control " value="system">
				<input name="referer" type="hidden" value="{if !empty($_GPC['referer'])}{$_GPC['referer']}{/if}">
				<input name="username" type="text" class="form-control " placeholder="请输入用户名/手机登录">
				<input name="password" id="password" type="password" class="form-control password" placeholder="请输入登录密码">
				<span style="display:none;color:red;">大写锁定已打开</span>
				{if !empty($_W['setting']['copyright']['verifycode'])}
				<div class="input-group">
					<input name="verify" type="text" class="form-control" placeholder="请输入验证码">
					<a href="javascript:;" id="toggle" class="input-group-btn imgverify"><img id="imgverify" src="{php echo url('utility/code')}" title="点击图片更换验证码" /></a>
				</div>
				{/if}
			</div>
			<div class="form-inline" style="margin-bottom: 15px;">
				<div class="pull-right">
<!--					<a href="{url 'user/find-password'}" target="_blank" class="color-default">忘记密码？</a>-->
				</div>
				<div class="checkbox">
					<input type="checkbox" value="true" id="rember" name="rember">
					<label for="rember">记住用户名</label>
				</div>
			</div>
			<div class="login-submit text-center">
				<input type="submit" class="btn btn-primary btn-block " value="登录" />
				<div class="text-right">
					{if empty($_W['siteclose']) && $setting['register']['open']}
						{if empty($_GPC['login_type']) || $_GPC['login_type'] == 'system'}
						<a href="{url 'user/register'}" class="color-default">立即注册</a>
						{/if}
					{/if}
				</div>
				<input name="token" value="{$_W['token']}" type="hidden" />
			</div>
			{if !empty($setting['thirdlogin']['qq']['authstate']) || !empty($setting['thirdlogin']['wechat']['authstate'])}
			<div class="text-center">
				<span class="color-gray">使用第三方账号登录</span>
				<div class="form-control-static">
					{if !empty($setting['thirdlogin']['qq']['authstate'])}<a href="{$login_urls['qq']}"><img src="./resource/images/qqlogin.png" width="35px"></a>&nbsp;&nbsp;{/if}
					{if !empty($setting['thirdlogin']['wechat']['authstate'])}<a href="{$login_urls['wechat']}"><img src="./resource/images/wxlogin.png" width="35px"></a>{/if}
				</div>
			</div>
			{/if}
		</form>
	</div>
	<div id="user-expired" class="modal fade in" tabindex="-1"  data-backdrop="static" data-keyboard="false" role="dialog" aria-hidden="true" >
		<div class="modal-dialog modal-tip">
			<div class="modal-content">
				<div class="modal-header clearfix">
				</div>
				<div class="modal-body">
					<div class="text-center">
						<i class="text-info wi wi-info"></i>
						<p class="title">系统提示</p>
						<p class="content"></p>
					</div>
					<div class="clearfix"></div></div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
	<div id="user-agreement" class="modal fade in" tabindex="-1"  data-backdrop="static" data-keyboard="false" role="dialog" aria-hidden="true" >
		<div class="modal-dialog modal-tip">
			<div class="modal-content">
				<div class="modal-header clearfix">
					<h4>&nbsp;&nbsp;&nbsp;微擎社区版更新协议<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></h4>

					<hr>
				</div>
				<div class="modal-body">
					<div class="text-left">
						<div class="content" style="color: #000;font-size: 12px;margin-top:-35px">
							<p>微擎社区版是一个去除云服务且功能无限制的版本，用户可在<a class="color-default" href="https://wiki.w7.com/chapter/326?id=1722" target="_blank">《微擎授权协议》</a>的约束下在此版本中自由使用；</p>
							<p>微擎官方对微擎社区版对扩展应用的小程序代码包一次性完全开放，用户可使用第三方平台提供的“开发者工具”将小程序代码包自由发布；</p>
							<p>微擎官方对微擎社区版去除了对应用“线上”、“线下”安装的区分，且统一采用了离线安装方式，用户可将应用代码包复制到安装目录下自由安装；</p>
							<p>微擎官方对微擎社区版的维护工作主要采用官方主导+第三方开发者辅助的社区模式，且统一采用了离线更新方式，官方会定期审查代码，发布补丁包，用户可将系统补丁包复制到安装目录下自由更新；</p>
							<p>微擎社区版的发布旨在听取用户意见，解决老用户在经济下行趋势的压力面临的困境，同时在结合自身团队的实际情况下做出的合适探索；</p>
							<p>微擎社区版不代表官方放弃了<a class="color-default" href="https://wiki.w7.com/chapter/326?id=1722" target="_blank">《微擎授权协议》</a>的权利与义务和对老用户的维护，也请用户在方便自己的同时尊重知识产权，请勿造成代码的盗版与传播，共同维护好社区版的开放生态；</p>
							<p>请用户妥善保管好已部署的代码文件，微擎社区版不具备线上备份代码的功能和再次提供下载的服务；</p>
							<hr>
							<p><span style="color: #999">提示：请用户认真阅读本协议内容，</span><span style="color: #cf1010">继续使用即代表同意本协议内容</span></p>
						</div>
					</div>
					<hr>
					<div class="clearfix"></div></div>
				<div class="modal-footer" style="margin-top:-20px">
					<button type="button" class="btn btn-default"  data-dismiss="modal">取消</button>
					<button type="button" class="btn btn-primary"  data-dismiss="modal" id="agreement">同意协议并继续</button>
				</div>
			</div>
		</div>
	</div>
</div>
{template 'common/footer'}

<script>
	function detectCapsLock(event) {
		var e = event || window.event;
		var o = e.target || e.srcElement;
		var oTip = o.nextElementSibling;
		var keyCode = e.keyCode || e.switch;
		var isShift = e.shiftKey || (keyCode == 16) || false;
		if (((keyCode >= 65 && keyCode <= 90) && !isShift) || ((keyCode >= 97 && keyCode <= 122) && isShift)) {
			oTip.style.display = '';
		} else {
			oTip.style.display = 'none';
		}
	}
	var getPost = function() {
		var postData = $("input").serializeArray();
		var postInit = {}
		for(var key in postData) {
			var data = postData[key]
			postInit[data.name] = data.value
		}
		if(postInit['rember']) {
			util.cookie.set('remember-username', postInit['username']);
		} else {
			util.cookie.del('remember-username');
		}
		return postInit;
	}
	var loginAction = function(e) {
		{if !empty($_W['setting']['copyright']['verifycode'])}
			var verify = $(':text[name="verify"]').val();
			if (verify == '') {
				alert('请填写验证码');
				return false;
			}
		{/if}
		e.preventDefault();
		postInit = getPost();
		$.post('', postInit, function(data) {
			if(!data || !data.message) {
				return false
			}
			if(data.message.errno === 0) {
				if (data.message.message.status == -1) {
					var showLabel = '';
					showLabel += '<a href="'+data.message.message.extend_buttons.cancel.url+'" class="btn btn-default">取消</a>';
					$('#user-expired').find('.modal-footer').html(showLabel);
					$('#user-expired').find('.content').html(data.message.message.message);
					$('#user-expired').modal('show')
					if (data.message.message.redirect) {
						setTimeout(function(){ window.location.href = data.message.message.redirect; }, 5000);
					}
					return true;
				} else if (data.message.message.status == -2) {
					$('#user-agreement').modal('show');
					return true;
				}
				util.message(data.message.message, data.redirect, 'success')
			} else {
				util.message(data.message.message)
				$('#imgverify').prop('src', '{php echo url('utility/code')}r='+Math.round(new Date().getTime()));
			}
		}, 'json');
	}
	$('#login-form').on('submit', loginAction);
	$('#agreement').click(function() {
		postInit = getPost();
		postInit['agreement'] = 1;
		$.post('', postInit, function(data) {
			if(data.message.errno === 0) {
				util.message(data.message.message, data.redirect, 'success')
			} else {
				util.message(data.message.message)
				$('#imgverify').prop('src', '{php echo url('utility/code')}r='+Math.round(new Date().getTime()));
			}
		}, 'json');
	});

	document.getElementById('password').onkeypress = detectCapsLock;
	var h = document.documentElement.clientHeight;
	if($('.footer').length) {
		h = h - $('.footer').outerHeight();
	}
	$('#toggle').click(function() {
		$('#imgverify').prop('src', '{php echo url('utility/code')}r='+Math.round(new Date().getTime()));
		return false;
	});
</script>
